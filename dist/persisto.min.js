/*! Persistent JavaScript objects and web forms using Web Storage. - v1.1.1-0 - 2017-10-29 |  https://github.com/mar10/persisto |  Copyright (c) 2017 Martin Wendt; Licensed MIT */

!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):"object"==typeof module&&module.exports?module.exports=a(require("jquery")):a(jQuery)}(function(a){"use strict";var b=9007199254740991,c=window.console,d=a.error;return window.PersistentObject=function(b,e){var f,g=this,h=a.Deferred(),i=Date.now();this instanceof PersistentObject||d("Must use 'new' keyword"),"string"!=typeof b&&d(this+": Missing required argument: namespace"),this.opts=a.extend({remote:null,defaults:{},commitDelay:500,createParents:!0,maxCommitDelay:3e3,pushDelay:5e3,maxPushDelay:3e4,storage:window.localStorage,debugLevel: 1,change:a.noop,commit:a.noop,conflict:a.noop,error:a.noop,pull:a.noop,push:a.noop,update:a.noop},e),this._checkTimer=null,this.namespace=b,this.storage=this.opts.storage,this._data=this.opts.defaults,this.offline=void 0,this.phase=null,this.uncommittedSince=null,this.unpushedSince=null,this.lastUpdate=0,this.lastPull=0,this.commitCount=0,this.pushCount=0,this.lastModified=i,this.ready=h.promise,f=this.storage?this.storage.getItem(this.namespace):null,this.opts.remote?this.pull().done(function(){g.offline=!1,h.resolve()}).fail(function(){g.offline=!0,null!=f?(c.warn(g+": could not init from remote; falling back to storage."),g._data=a.extend({},g.opts.defaults,JSON.parse(f))):c.warn(g+": could not init from remote; falling back default."),h.resolve()}):null!=f?(this.update(),this._data=a.extend({},this.opts.defaults,this._data),h.resolve()):h.resolve()},window.PersistentObject.prototype={version:"1.1.1-0",_invalidate:function(a,c){var d=this,e=this.lastModified,f=Date.now(),g=0,h=0,i=0;this._checkTimer&&(clearTimeout(this._checkTimer),this._checkTimer=null),c?this.debug("_invalidate() recursive"):(this.lastModified=f,this.uncommittedSince||(this.uncommittedSince=f),this.unpushedSince||(this.unpushedSince=f),this.opts.change(a)),this.storage&&(f-e>=this.opts.commitDelay||f-this.uncommittedSince>=this.opts.maxCommitDelay?(this.debug("_invalidate(): force commit",f-e>=this.opts.commitDelay,f-this.uncommittedSince>=this.opts.maxCommitDelay),this.commit()):g=Math.min(f+this.opts.commitDelay+1,this.uncommittedSince+this.opts.maxCommitDelay+1)),this.opts.remote&&(f-e>=this.opts.pushDelay||f-this.unpushedSince>=this.opts.maxPushDelay?(this.debug("_invalidate(): force push",f-e>=this.opts.pushDelay,f-this.unpushedSince>=this.opts.maxPushDelay),this.push()):h=Math.min(f+this.opts.pushDelay+1,this.unpushedSince+this.opts.maxPushDelay+1)),(g||h)&&(i=Math.min(g||b,h||b),this.debug("_invalidate("+a+") defer by "+(i-f)+"ms"),this._checkTimer=setTimeout(function(){d._checkTimer=null,d._invalidate.call(d,null,!0)},i-f))},_update:function(a){this.uncommittedSince&&(c.warn("Updating an uncommitted object."),this.conflict(a,this._data)===!1)||(this._data=a,this.lastUpdate=Date.now())},toString:function(){return"PersistentObject('"+this.namespace+"')"},debug:function(){this.opts.debugLevel>=2&&(Array.prototype.unshift.call(arguments,this.toString()),c.log.apply(c,arguments))},log:function(){this.opts.debugLevel>=1&&(Array.prototype.unshift.call(arguments,this.toString()),c.log.apply(c,arguments))},isDirty:function(){return!!(this.storage&&this.uncommittedSince||this.opts.remote&&this.unpushedSince)},isReady:function(){return"pending"!==this.ready.state},get:function(a){var b,c=this._data,e=(""+a).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split(".");for(b=0;b<e.length;b++)c=c[e[b]],void 0===c&&b<e.length-1&&d(this+": Property '"+a+"' could not be accessed because parent '"+e.slice(0,b+1).join(".")+"' does not exist");return c},_setOrRemove:function(a,b,c){var e,f,g=this._data,h=(""+a).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),i=h.pop();for(e=0;e<h.length;e++)f=g,g=f[h[e]],void 0===g&&(this.opts.createParents?(this.debug("Creating intermediate parent '"+h[e]+"'"),g=f[h[e]]={}):d(this+": Property '"+a+"' could not be set because parent '"+h.slice(0,e+1).join(".")+"' does not exist"));g[i]!==b&&(c===!0?(delete g[i],this._invalidate("remove")):(g[i]=b,this._invalidate("set")))},set:function(a,b){return this._setOrRemove(a,b,!1)},remove:function(a){return this._setOrRemove(a,void 0,!0)},reset:function(a){this._data=a||{},this._invalidate("reset")},setDirty:function(a){a===!1||this._invalidate("explicit")},update:function(){this.phase&&d(this+": Trying to update while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&c.time&&c.time(this+".update");var a=this.storage.getItem(this.namespace);a=JSON.parse(a),this._update(a),this.opts.debugLevel>=2&&c.time&&c.timeEnd(this+".update")},commit:function(){var a;return this.phase&&d(this+": Trying to commit while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&c.time&&c.time(this+".commit"),a=JSON.stringify(this._data),this.storage.setItem(this.namespace,a),this.uncommittedSince=null,this.commitCount+=1,this.opts.debugLevel>=2&&c.time&&c.timeEnd(this+".commit"),a},pull:function(){var b=this;return this.phase&&d(this+": Trying to pull while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&c.time&&c.time(this+".pull"),this.phase="pull",a.ajax({type:"GET",url:this.opts.remote}).done(function(c){var d=c;a.isArray(c)||a.isPlainObject(c)?d=JSON.stringify(c):c=JSON.parse(c),b.storage.setItem(b.namespace,d),b._update(c),b.lastPull=Date.now()}).fail(function(){b.opts.error(arguments)}).always(function(){b.phase=null,b.opts.debugLevel>=2&&c.time&&c.timeEnd(b+".pull")})},push:function(){var b=this,e=this.commit();return this.phase&&d(this+": Trying to push while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&c.time&&c.time(b+".push"),this.phase="push",this.opts.remote||d(this+": Missing remote option"),a.ajax({type:"PUT",url:this.opts.remote,data:e}).done(function(){b.unpushedSince=null,b.pushCount+=1}).fail(function(){b.opts.error(arguments)}).always(function(){b.phase=null,b.opts.debugLevel>=2&&c.time&&c.timeEnd(b+".push")})},readFromForm:function(b,c){var d=this,e=a(b),f=a.extend({addNew:!1,coerce:!0,trim:!0},c);f.addNew&&e.find("[name]").each(function(){var b=a(this).attr("name");void 0===d._data[b]&&(d.debug("readFromForm: add field '"+b+"'"),d._data[b]=null)}),a.each(this._data,function(b,c){var g,h=e.find("[name='"+b+"']"),i=h.attr("type");return h.length?("radio"===i?g=h.filter(":checked").val():"checkbox"===i&&1===h.length?g=!!h.filter(":checked").length:"checkbox"===i&&h.length>1?(g=[],h.filter(":checked").each(function(){g.push(a(this).val())})):(g=h.val(),f.trim&&"string"==typeof g&&(g=a.trim(g))),void d.set(b,g)):void d.debug("readFromForm: field not found: '"+b+"'")})},writeToForm:function(b,c){var d=a(b);a.each(this._data,function(b,c){var e=d.find("[name='"+b+"']"),f=e.attr("type");e.length&&("radio"===f?e.filter("[value='"+c+"']").prop("checked",!0):"checkbox"===f?1===e.length?e.prop("checked",!!c):e.each(function(){a(this).prop("checked",a.isArray(c)?a.inArray(this.value,c)>=0:this.value===c)}):e.is("select")?e.find("option").each(function(){a(this).prop("selected",a.isArray(c)?a.inArray(this.value,c)>=0:this.value===c)}):e.val(c))})}},window.PersistentObject});
//# sourceMappingURL=persisto.min.js.map